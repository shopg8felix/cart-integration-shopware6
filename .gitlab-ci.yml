stages:
  - build
  - test
  - deploy

variables:
  PROJECT_ROOT: $CI_PROJECT_DIR
  WEB_DOCUMENT_ROOT: $CI_PROJECT_DIR/public
  LOG_STDOUT: $CI_PROJECT_DIR/var/log/stdout.log
  MYSQL_DATABASE: shopware
  MYSQL_ROOT_PASSWORD: rootPass
  DATABASE_URL: "mysql://root:rootPass@database:3306/shopware?sslmode=disable&charset=utf8mb4"
  GIT_STRATEGY: clone
  NPM_CONFIG_CACHE: "$CI_PROJECT_DIR/.cache/npm"
  GIT_CLONE_PATH: $CI_BUILDS_DIR/$CI_CONCURRENT_ID/$PLUGIN_NAME
  # things plugins might want to override
  APP_ENV: dev
  APP_DEBUG: 0
  APP_SECRET: 123456
  MYSQL_IMAGE: mariadb:10.3
  MYSQL_CMD: mysqld
  PHP: '7.4'
  PLATFORM_BRANCH: 6.4.11.0
  PLUGIN_NAME: 'SgateShopgatePluginSW6'
  PLUGIN_SOURCE_DIR: src/
  PLUGIN_COMPOSER_SDK_NAME: 'shopgate/cart-integration-sdk'
  MOCK_SERVER_URL: 'http://127.0.0.1:3000'
  VERBOSE: ''
  # throws an exception when Criteria class has empty ids passed to it
  FEATURE_NEXT_16710: 1

.cache: &cache
  key: $PLUGIN_NAME-$PLATFORM_BRANCH
  policy: pull
  paths:
    - .cache/npm
    - vendor/

workflow:
  rules:
    # do not run on push unless it has a tag
    - if: '$CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_TAG == null'
      when: never
    - when: always

.defaults: &defaults
  image: shopware/development:$PHP-composer-2
  cache:
    <<: *cache
  services:
    - name: $MYSQL_IMAGE
      alias: database
      entrypoint: [ "sh", "-c", "docker-entrypoint.sh $MYSQL_CMD" ]
  before_script:
    - export APP_URL="http://$HOSTNAME"
    - apt update > /dev/null
    - apt-get install -y jq > /dev/null
    - PLUGIN_COMPOSER_NAME=$(jq -r ".name" composer.json)
    - PLUGIN_COMPOSER_SDK_VERSION=$(cat composer.json | jq --raw-output --arg sdk "$PLUGIN_COMPOSER_SDK_NAME" '.require[$sdk]')
    - '[ -d vendor ] && mv vendor /tmp/'
    - '[ -d .cache ] && mv .cache /tmp/'
    - zip -rq plugin.zip .
    - mv plugin.zip /tmp/plugin.zip
    - rm -Rf .* * || true
    - git clone https://github.com/shopware/platform.git . --branch $PLATFORM_BRANCH --depth 50
    - '[ -d /tmp/vendor ] && mv /tmp/vendor ./'
    - '[ -d /tmp/.cache ] && mv /tmp/.cache ./'
    - mkdir -p custom/plugins || true
    - unzip -q /tmp/plugin.zip -d custom/plugins/$PLUGIN_NAME
    - composer require "$PLUGIN_COMPOSER_SDK_NAME":"$PLUGIN_COMPOSER_SDK_VERSION" --no-update
    - composer install -n --quiet
    - mkdir -p config/jwt || true
    - bin/console system:generate-jwt || true
    - bin/console system:install --drop-database --basic-setup --force --no-interaction --quiet
    - bin/console plugin:refresh --quiet
    - bin/console plugin:install --quiet --activate $PLUGIN_NAME
    - >
      if bin/console debug:container --parameter kernel.plugin_infos --format json | grep -q "$PLUGIN_NAME";
        then echo "$PLUGIN_NAME is active";
        else echo "$PLUGIN_NAME is not active"; exit 1;
      fi
    - bin/console bundle:dump
    - bin/console assets:install --quiet
    - chown -R 1000:1000 .
    - /entrypoint supervisord > /dev/null 2>&1 &

newman:
  <<: *defaults
  stage: test
  cache:
    <<: *cache
    policy: pull-push
  parallel:
    matrix:
      - PLATFORM_BRANCH:
          - 6.4.8.0
          - 6.4.11.0
      - PHP:
          - '8.0'
  except:
    - tags
  script:
    - npm install -g newman@^5.3.0 newman-reporter-htmlextra @mockoon/cli@1.5.* > /dev/null
    - APP_ENV=prod php bin/console store:download -p SwagPlatformDemoData
    - bin/console plugin:install --quiet --activate SwagPlatformDemoData
    - mockoon-cli start --data ${PROJECT_ROOT}/custom/plugins/$PLUGIN_NAME/tests/Mockoon/environment.json --all --hostname $APP_URL
    - cd ${PROJECT_ROOT}/custom/plugins/$PLUGIN_NAME/tests/Postman;
    - newman run ./collection.json -g ./globals.json -e ./environment.json -r cli,htmlextra,junit
      --reporter-htmlextra-export ${PROJECT_ROOT}/postman-report.html --reporter-junit-export ${PROJECT_ROOT}/newman.junit.xml
      --color on --insecure --no-insecure-file-read
      --env-var "host=$APP_URL" --global-var "mock_server_merchant_uri=$MOCK_SERVER_URL" --global-var "verbose=$VERBOSE";
  artifacts:
    when: on_failure
    expire_in: 7 days
    reports:
      junit: newman.junit.xml
    paths:
      - ./postman-report.html

register package:
  image: curlimages/curl:latest
  services: [ ]
  stage: build
  only:
    - tags
  variables:
    URL: "$CI_SERVER_PROTOCOL://$CI_SERVER_HOST:$CI_SERVER_PORT/api/v4/projects/$CI_PROJECT_ID/packages/composer?job_token=$CI_JOB_TOKEN"
  before_script: [ ]
  script:
    - version=$([[ -z "$CI_COMMIT_TAG" ]] && echo "branch=$CI_COMMIT_REF_NAME" || echo "tag=$CI_COMMIT_TAG")
    - insecure=$([ "$CI_SERVER_PROTOCOL" = "http" ] && echo "--insecure" || echo "")
    - response=$(curl -s -w "\n%{http_code}" $insecure --data $version $URL)
    - code=$(echo "$response" | tail -n 1)
    - body=$(echo "$response" | head -n 1)
    # Output state information
    - if [ $code -eq 201 ]; then
      echo "Package created - Code $code - $body";
      else
      echo "Could not create package - Code $code - $body";
      exit 1;
      fi

build zip:
  <<: *defaults
  stage: build
  only:
    - tags
  script:
    - composer require frosh/plugin-uploader:0.3.19
    - cd $CI_PROJECT_DIR/custom/plugins/$PLUGIN_NAME
    - cp ./devops/rewrites/DescriptionLengthChecker.php $PROJECT_ROOT/vendor/frosh/plugin-uploader/src/Components/PluginValidator/General/
    - $PROJECT_ROOT/vendor/bin/pluginupload ext:zip --strategy=plain -- "$PWD"
    - $PROJECT_ROOT/vendor/bin/pluginupload ext:validate $PLUGIN_NAME.zip
    - '[[ -r $PLUGIN_NAME.zip ]] || (echo "failed to create $PLUGIN_NAME.zip. Please run ./bin/init $PLUGIN_NAME" && exit 1)'
    - mv $PLUGIN_NAME.zip ${CI_PROJECT_DIR}/$PLUGIN_NAME.zip
  artifacts:
    name: '${PLUGIN_NAME}'
    expire_in: never
    paths:
      - '${PLUGIN_NAME}.zip'

publish to marketplace:
  stage: deploy
  environment:
    name: account.shopware.com
    url: 'https://account.shopware.com'
  image:
    name: ghcr.io/friendsofshopware/platform-plugin-dev:v6.4.4
    entrypoint: [ "" ]
  services: [ ]
  variables:
    GIT_STRATEGY: none
  needs:
    - build zip
  rules:
    - if: $CI_COMMIT_TAG != null && $CI_COMMIT_TAG !~ /beta|alpha/i
  before_script: [ ]
  script:
    - zip -d $(realpath "$PLUGIN_NAME.zip") "$PLUGIN_NAME/composer.lock"
    - plugin-uploader ext:upload "$(realpath "$PLUGIN_NAME.zip")"

.downstreamDefaults: &downstreamDefaults
  except:
    - tags
  variables:
    UPSTREAM_BRANCH: $CI_COMMIT_REF_NAME
    UPSTREAM_REF: $CI_COMMIT_SHA
  inherit:
    variables: false

downstream replyCert:
  <<: *downstreamDefaults
  trigger:
    project: apite/shopgate/shopware6/reply-certificate
    branch: ver-1.x

downstream acrisSurcharge:
  <<: *downstreamDefaults
  trigger:
    project: apite/shopgate/shopware6/acris-surcharge
    branch: ver-1.x

downstream dynamicAccess:
  <<: *downstreamDefaults
  trigger:
    project: apite/shopgate/shopware6/shopware-dynamic-access
    branch: main

downstream vatIdMapping:
  <<: *downstreamDefaults
  trigger:
    project: apite/shopgate/shopware6/shopgate-vat-id-mapping
    branch: main
